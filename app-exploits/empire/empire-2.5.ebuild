# Copyright 1999-2018 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

EAPI=6

PYTHON_COMPAT=( python2_7 )
EGO_PN=github.com/EmpireProject/Empire

inherit python-single-r1

if [[ ${PV} = *9999* ]]; then
	inherit git-r3
	EGIT_REPO_URI="https://github.com/EmpireProject/Empire.git"
	KEYWORDS=""
else
	KEYWORDS="~amd64 ~x86"
	EGIT_COMMIT="${PV}"
	SRC_URI="https://${EGO_PN}/archive/${EGIT_COMMIT}.tar.gz -> ${P}.tar.gz"
fi

DESCRIPTION="A post-exploitation framework with Windows/Linux agents"
HOMEPAGE="https://github.com/EmpireProject/Empire"

LICENSE="BSD-3-Clause"
SLOT="0"
#WIP
#KEYWORDS="~amd64 ~x86"
IUSE="java"

RDEPEND="dev-lang/swig

	dev-python/lxml
	dev-python/pyminifier
	dev-python/xlrd
	dev-python/xlwt

	>=dev-python/urllib3-1.21.1[${PYTHON_USEDEP}]
	>=dev-python/requests-2.18.4[${PYTHON_USEDEP}]
	dev-python/python-iptools[${PYTHON_USEDEP}]
	dev-python/pydispatcher[${PYTHON_USEDEP}]
	dev-python/flask[${PYTHON_USEDEP}]
	dev-python/macholib[${PYTHON_USEDEP}]
	dev-python/dropbox-sdk[${PYTHON_USEDEP}]
	>=dev-python/pyopenssl-17.2.0[${PYTHON_USEDEP}]
	dev-python/pyinstaller[${PYTHON_USEDEP}]
	dev-python/zlib_wrapper[${PYTHON_USEDEP}]
	dev-python/netifaces[${PYTHON_USEDEP}]
	dev-python/m2crypto[${PYTHON_USEDEP}]
	dev-python/jinja[${PYTHON_USEDEP}]
	dev-python/cryptography[${PYTHON_USEDEP}]
	>=dev-python/pyminifier-2.1[${PYTHON_USEDEP}]
	dev-python/xlutils[${PYTHON_USEDEP}]
	dev-python/pycryptodome[${PYTHON_USEDEP}]

	dev-python/pefile[${PYTHON_USEDEP}]

	java? ( virtual/jre:* )"

DEPEND="${RDEPEND}
	dev-python/setuptools[${PYTHON_USEDEP}]"

S="${WORKDIR}/Empire-${PV}"

pkg_postinst() {
	elog "You need to prepare the database by running:"
	elog "emerge --config =empire-${PV}"
}

pkg_config() {
#	einfo "If the following fails, it is likely because you forgot to start/config postgresql first"
#	su postgres -c "createuser msf_user -D -S -R"
#	su postgres -c "createdb --owner=msf_user msf_database"
	einfo "Run setup/setup_database.py to create empire.db"
}
